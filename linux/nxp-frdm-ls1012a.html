<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NXP FRDM-LS1012A board - Notes ...</title>

    <link rel="shortcut icon" href="/styles/images/favicon.jpg">
    <link rel="icon" href="/styles/images/favicon.jpg">

    <link rel="stylesheet" href="/assets/css/wordpress.css">
    <link rel="canonical" href="/linux/nxp-frdm-ls1012a.html">

    <link rel="stylesheet" href="/assets/prism/prism.css">
    <script src="/assets/prism/prism.js"></script>
    <script src="https://kit.fontawesome.com/45a69050db.js" crossorigin="anonymous"></script>

    <meta name="keywords" content="NXP FRDM-LS1012A board, Notes ..., 学而不思则罔;思而不学则殆;生命不止;折腾不休">
    <meta name="description" content="学而不思则罔;思而不学则殆;生命不止;折腾不休">
</head>

<body class="index">
    <header id="header" itemscope="" itemtype="https://schema.org/WPHeader">
    <div id="head-in">
        <div id="head-parallax" style="overflow: hidden; background-position: 0px 0px;">
            <div class="head-cover" style="transform: translate(0px, 0px);">
                <div class="info" itemscope="" itemtype="https://schema.org/Website">
                    <h1 id="sitename">
                        <a href="/" itemprop="url"><img src="/assets/images/logo.svg" alt="" width="150" height="150" class="onepoint" itemprop="image" sizes="(max-width: 150px) 100vw, 150px"><span itemprop="name about">Linux Ref</span></a>
                    </h1>
                    <meta itemprop="alternativeHeadline" content="Linux tutorials, settings etc.">
                </div>
                <!--/.info-->
            </div>
            <!--/.head-cover-->
        </div>
        <!--/#head-parallax-->
    </div>
</header>
    <div class="container">
        

<div itemprop="breadcrumb">
    <ol id="breadcrumb">
        <li>
            <i class="fas fa-home"></i>
            <a href="/">ホーム</a>
            <i class="arrow">&gt;</i>
        </li>
        
        
        
            
            
            





<li>

<i class="fas fa-folder-open"></i>
<a href="/category/linux/">Linux</a>

</li>

    </ol>
</div>
<!-- 
    <div>value of name listsize:1</div>
    <div>value of href listsize:1</div>
    <div>value of count:0</div>
    
    <div>value of i:0</div>
    
     -->
<div id="primary" class="clearfix">
    <main id="main">
        <article>
            <div id="core" class="grid">
                <div itemprop="mainEntityOfPage" id="mainEntity" class="post post-109 type-post status-publish format-standard has-post-thumbnail hentry category-server tag-debian tag-linux tag-omv tag-openmediavault tag-server tag-wordpress ja">
                    <header id="article-header">
                        <h1 class="entry-title" itemprop="headline name">NXP FRDM-LS1012A board</h1>
                    </header>
                    <div class="clearfix">
                        <p class="meta">
                            <i class="far fa-clock"></i>
                            <span class="date published">
                                <time class="entry-date updated" datetime="2018-02-09T15:55:57+09:00" itemprop="datePublished">
                                    09 Feb 2018
                                </time>
                            </span>
                            <i class="fas fa-redo-alt"></i>
                            <span class="date">
                                <meta itemprop="dateModified" content="2020-08-23T17:24:54+09:00">
                                DUMMY STRING
                            </span>
                        </p>
                        <div id="toc_container">
<span class="toc_title">Contents</span><input id="toc_toggle" type="checkbox" checked><label class="toc_toggle" for="toc_toggle"></label>
                            <ul id="" class="toc_list">
<li class=" toc-h1"><a href="#reference">Reference</a></li>
<li class=" toc-h1">
<a href="#useful-commands">Useful commands</a>
<ul>
<li class=" toc-h2"><a href="#general-ones">General ones</a></li>
<li class=" toc-h2"><a href="#kernel">Kernel</a></li>
<li class=" toc-h2">
<a href="#u-boot">U-Boot</a>
<ul>
<li class=" toc-h3"><a href="#nfs-startup-this-was-failed-because-booting-from-tftp-will-cause-network-be-invalid">nfs startup (This was failed! because booting from tftp will cause network be invalid)</a></li>
<li class=" toc-h3"><a href="#boot-from-flash">boot from flash</a></li>
<li class=" toc-h3"><a href="#read-itb-image-from-tftp-and-burn-it-to-flash">read itb image from tftp and burn it to flash</a></li>
<li class=" toc-h3"><a href="#boot-from-tftp">boot from tftp</a></li>
</ul>
</li>
</ul>
</li>
<li class=" toc-h1">
<a href="#ethernet-driver">Ethernet Driver</a>
<ul>
<li class=" toc-h2">
<a href="#about-napi">About NAPI</a>
<ul>
<li class=" toc-h3"><a href="#reference-1">reference</a></li>
<li class=" toc-h3">
<a href="#apis">APIs</a>
<ul>
<li class=" toc-h4"><a href="#essential">Essential</a></li>
<li class=" toc-h4"><a href="#non-essential">Non-Essential</a></li>
</ul>
</li>
<li class=" toc-h3"><a href="#design">Design</a></li>
<li class=" toc-h3"><a href="#poll-function">Poll() function</a></li>
</ul>
</li>
<li class=" toc-h2"><a href="#files">Files</a></li>
<li class=" toc-h2">
<a href="#call-tree">call tree</a>
<ul>
<li class=" toc-h3"><a href="#path-from-interrupt-handler">Path from interrupt handler</a></li>
<li class=" toc-h3"><a href="#path-from-platforms-poll">Path from platform’s poll</a></li>
<li class=" toc-h3"><a href="#ethernet-drivers-event_handler">Ethernet driver’s event_handler:</a></li>
<li class=" toc-h3"><a href="#path-from-ethernets-poll">Path from ethernet’s poll</a></li>
<li class=" toc-h3"><a href="#path-from-probe">Path from probe()</a></li>
</ul>
</li>
</ul>
</li>
</ul>
                        </div>
                        <ul id="markdown-toc">
  <li><a href="#reference" id="markdown-toc-reference">Reference</a></li>
  <li>
<a href="#useful-commands" id="markdown-toc-useful-commands">Useful commands</a>    <ul>
      <li><a href="#general-ones" id="markdown-toc-general-ones">General ones</a></li>
      <li><a href="#kernel" id="markdown-toc-kernel">Kernel</a></li>
      <li>
<a href="#u-boot" id="markdown-toc-u-boot">U-Boot</a>        <ul>
          <li><a href="#nfs-startup-this-was-failed-because-booting-from-tftp-will-cause-network-be-invalid" id="markdown-toc-nfs-startup-this-was-failed-because-booting-from-tftp-will-cause-network-be-invalid">nfs startup (<em>This was failed! because booting from tftp will cause network be invalid</em>)</a></li>
          <li><a href="#boot-from-flash" id="markdown-toc-boot-from-flash">boot from flash</a></li>
          <li><a href="#read-itb-image-from-tftp-and-burn-it-to-flash" id="markdown-toc-read-itb-image-from-tftp-and-burn-it-to-flash">read itb image from tftp and burn it to flash</a></li>
          <li><a href="#boot-from-tftp" id="markdown-toc-boot-from-tftp">boot from tftp</a></li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
<a href="#ethernet-driver" id="markdown-toc-ethernet-driver">Ethernet Driver</a>    <ul>
      <li>
<a href="#about-napi" id="markdown-toc-about-napi">About NAPI</a>        <ul>
          <li><a href="#reference-1" id="markdown-toc-reference-1">reference</a></li>
          <li>
<a href="#apis" id="markdown-toc-apis">APIs</a>            <ul>
              <li><a href="#essential" id="markdown-toc-essential">Essential</a></li>
              <li><a href="#non-essential" id="markdown-toc-non-essential">Non-Essential</a></li>
            </ul>
          </li>
          <li><a href="#design" id="markdown-toc-design">Design</a></li>
          <li><a href="#poll-function" id="markdown-toc-poll-function">Poll() function</a></li>
        </ul>
      </li>
      <li><a href="#files" id="markdown-toc-files">Files</a></li>
      <li>
<a href="#call-tree" id="markdown-toc-call-tree">call tree</a>        <ul>
          <li><a href="#path-from-interrupt-handler" id="markdown-toc-path-from-interrupt-handler">Path from interrupt handler</a></li>
          <li><a href="#path-from-platforms-poll" id="markdown-toc-path-from-platforms-poll">Path from platform’s poll</a></li>
          <li><a href="#ethernet-drivers-event_handler" id="markdown-toc-ethernet-drivers-event_handler">Ethernet driver’s <code>event_handler:</code></a></li>
          <li><a href="#path-from-ethernets-poll" id="markdown-toc-path-from-ethernets-poll">Path from ethernet’s poll</a></li>
          <li><a href="#path-from-probe" id="markdown-toc-path-from-probe">Path from probe()</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="reference">Reference</h1>

<ul>
  <li><a href="/linux/yocto-get-start.html">Yocto Notes</a></li>
  <li><a href="https://www.nxp.com/docs/en/supporting-information/QORIQ-SDK-2.0-IC-REV0.pdf">QorIQ SDK V2.0-1703 Documentation</a></li>
</ul>

<h1 id="useful-commands">Useful commands</h1>

<h2 id="general-ones">General ones</h2>

<ul>
  <li>
<code>bitbake -e &lt;package-name&gt; | grep ^S= </code><br>
get value of <code>&lt;S&gt;</code>, the package source code.
for example, get the kernel source directory: <code>bitbake -e virtual/kernel | grep ^S=</code>
</li>
</ul>

<h2 id="kernel">Kernel</h2>

<ul>
  <li>
<code>bitbake -c cleansstate virtual/kernel</code> clean kernel build result</li>
  <li>
<code>bitbake -c menuconfig virtual/kernel</code> menuconfig kernel</li>
  <li>
<code>bitbake virtual/kernel</code> build kernel</li>
</ul>

<h2 id="u-boot">U-Boot</h2>

<h3 id="nfs-startup-this-was-failed-because-booting-from-tftp-will-cause-network-be-invalid">nfs startup (<em>This was failed! because booting from tftp will cause network be invalid</em>)</h3>
<pre><code class="line-numbers">setenv bootargs root=/dev/nfs rw nfsroot=192.168.137.2:/home/bjn/wk/nfsboot ip=192.168.137.3:192.168.137.2:192.168.137.2:255.255.255.0:nxp_board:eth0:off console=ttyS0,115200 earlycon=uart8250,mmio,0x21c0500
setenv bootcmd tftp 96000000  kernel-fsl-ls1012a-frdm.itb\; pfe stop \; bootm 96000000:kernel@1 - 96000000:fdt@1
</code></pre>

<h3 id="boot-from-flash">boot from flash</h3>
<pre><code class="line-numbers">setenv bootargs console=ttyS0,115200 root=/dev/ram0 earlycon=uart8250,mmio,0x21c0500
setenv bootcmd pfe stop\; sf probe 0:0\; sf read $kernel_load $kernel_start $kernel_size \&amp;\&amp; bootm $kernel_load
</code></pre>

<h3 id="read-itb-image-from-tftp-and-burn-it-to-flash">read itb image from tftp and burn it to flash</h3>
<pre><code class="line-numbers">tftp 0x96000000 kernel-fsl-ls1012a-frdm.itb ; sf probe 0:0 ; sf erase 0xa00000 +$filesize ; sf write 0x96000000 0xa00000 $filesize ; boot
</code></pre>

<h3 id="boot-from-tftp">boot from tftp</h3>
<pre><code class="line-numbers">setenv bootcmd tftp 0x96000000 kernel-fsl-ls1012a-frdm.itb \; pfe stop \; bootm 0x96000000
</code></pre>

<pre><code class="line-numbers">tftp 0x96000000 kernel-fsl-ls1012a-frdm.itb ; pfe stop; bootm 0x96000000
</code></pre>

<h1 id="ethernet-driver">Ethernet Driver</h1>

<h2 id="about-napi">About NAPI</h2>

<h3 id="reference-1">reference</h3>
<ul>
  <li><a href="https://wiki.linuxfoundation.org/networking/napi">Linuxfoundation WiKi</a></li>
</ul>

<h3 id="apis">APIs</h3>

<h4 id="essential">Essential</h4>
<ul>
  <li>
<code>netif_napi_add(dev, napi, poll, weight)</code>
    <ul>
      <li>Initialises and registers <code>napi</code> structure for polling <code>dev</code>
</li>
    </ul>
  </li>
  <li>
<code>napi_schedule(napi)</code>
    <ul>
      <li>Called by an IRQ handler to schedule a poll for <code>napi</code>
</li>
      <li>same as
        <pre><code class="line-numbers">  if (napi_schedule_prep(napi))
     __napi_schedule(napi);
</code></pre>
      </li>
    </ul>
  </li>
  <li>
<code>napi_complete(napi)</code>
    <ul>
      <li>Remove <code>napi</code> from the CPU poll list: it must be in the poll list on current cpu. 
  This primitive is called by <code>napi-&gt;poll()</code>, when it completes its work. 
  The structure cannot be out of poll list at this call, if it is then clearly it is a BUG().</li>
    </ul>
  </li>
</ul>

<h4 id="non-essential">Non-Essential</h4>
<ul>
  <li>
<code>netif_napi_del(napi)</code>
    <ul>
      <li>Unregisters napi structure; must be called after the associated device is unregistered. 
  free_netdev(dev) will call netif_napi_del() for all napi_structs still 
  associated with the net device, so it may not be necessary for the driver to call this directly.</li>
    </ul>
  </li>
  <li>
<code>napi_reschedule(napi)</code>
    <ul>
      <li>Called to reschedule polling for <code>napi</code> specifically for some deficient hardware.</li>
    </ul>
  </li>
  <li>
<code>__napi_complete(napi)</code>
    <ul>
      <li>same as <code>napi_complete()</code> but called when local interrupts are already disabled.</li>
    </ul>
  </li>
  <li>
<code>napi_disable(napi)</code>
    <ul>
      <li>Temporarily disables napi structure from being polled. May sleep if it is currently being polled</li>
    </ul>
  </li>
  <li>
<code>napi_enable(napi)</code>
    <ul>
      <li>Reenables napi structure for polling, after it was disabled using <code>napi_disable()</code>
</li>
    </ul>
  </li>
  <li>
<code>napi_reschedule(napi)</code>
    <ul>
      <li>Called to reschedule polling for napi specifically for some deficient hardware.</li>
    </ul>
  </li>
</ul>

<h3 id="design">Design</h3>

<ol>
  <li>Register NAPI
    <pre><code class="line-numbers"> probe() -&gt; netif_napi_add()
</code></pre>
  </li>
  <li>Driven be Interrupt
    <pre><code class="line-numbers"> Interrupt -&gt; napi_reschedule()
</code></pre>
  </li>
  <li>poll when timing is right
    <pre><code class="line-numbers"> xxx? -&gt; napi's poll()
</code></pre>
  </li>
</ol>

<h3 id="poll-function">Poll() function</h3>

<p>defined as <code>int (*poll)(struct napi_struct *napi, int budget);</code>.</p>
<ul>
  <li>Packets should <em>NOT</em> be passed to netif_rx(); instead, use: <code>int netif_receive_skb(struct sk_buff *skb)</code>
</li>
</ul>

<h2 id="files">Files</h2>

<ul>
  <li>
<code>drivers/staging/fsl_ppfe/pfe_eth.h</code> ethernet driver header</li>
  <li>
<code>drivers/staging/fsl_ppfe/pfe_eth.c</code> ethernet driver source</li>
  <li>
<code>drivers/staging/fsl_ppfe/pfe_ls1012a_platform.c</code> platform common code</li>
  <li>
<code>drivers/staging/fsl_ppfe/pfe_platform.c</code>
    <ul>
      <li>this is not used, see <code>drivers/staging/fsl_ppfe/Makefile</code> below
        <pre><code class="line-numbers">  pfe-y += pfe_mod.o \
  pfe_hw.o \
  pfe_firmware.o \
  pfe_ctrl.o \
  pfe_ctrl_hal.o \
  pfe_hif.o \
  pfe_hif_lib.o\
  pfe_eth.o \
  pfe_perfmon.o \
  pfe_sysfs.o \
  pfe_debugfs.o \
  pfe_ls1012a_platform.o \
  pfe_hal.o  \
</code></pre>
      </li>
    </ul>
  </li>
</ul>

<h2 id="call-tree">call tree</h2>

<h3 id="path-from-interrupt-handler">Path from interrupt handler</h3>
<p>drivers/staging/fsl_ppfe/pfe_hif.c:</p>
<pre><code class="language-cpp line-numbers">static irqreturn_t hif_isr(int irq, void *dev_id)
{
	struct pfe_hif *hif = (struct pfe_hif *) dev_id;
...
	if (napi_schedule_prep(&amp;hif-&gt;napi))
	{
		__napi_schedule(&amp;hif-&gt;napi);
...
</code></pre>

<h3 id="path-from-platforms-poll">Path from platform’s poll</h3>
<p>drivers/staging/fsl_ppfe/pfe_hif.c:</p>
<pre><code class="language-cpp line-numbers">static int pfe_hif_rx_poll(struct napi_struct *napi, int budget)
	work_done = pfe_hif_rx_process(hif, budget);
		rtc = hif-&gt;RxtocleanIndex;
		desc = hif-&gt;RxBase + rtc;
		free_buf = client_put_rxpacket(&amp;hif-&gt;client[hif-&gt;client_id].rx_q[hif-&gt;qno],
			(void *)pkt_hdr, len, flags, hif-&gt;client_ctrl, &amp;buf_size);
		desc-&gt;data = DDR_PHYS_TO_PFE((u32)DMA_MAP_SINGLE(hif-&gt;dev, free_buf, hif-&gt;rx_buf_len[rtc], DMA_FROM_DEVICE));

		hif_lib_indicate_client(hif-&gt;client_id, EVENT_RX_PKT_IND, hif-&gt;qno);
            client-&gt;event_handler(client-&gt;priv, event_type, qno);
</code></pre>

<h3 id="ethernet-drivers-event_handler">Ethernet driver’s <code>event_handler:</code>
</h3>
<p>drivers/staging/fsl_ppfe/pfe_eth.c:</p>
<pre><code class="language-cpp line-numbers">static int pfe_eth_open(struct net_device *dev)
{
...
    client-&gt;event_handler   = pfe_eth_event_handler
...  

static int pfe_eth_event_handler(void *data, int event, int qno)
{
    switch (event) {
        case EVENT_RX_PKT_IND:
        if (qno == 0) {
            __napi_schedule(&amp;priv-&gt;high_napi);
        ...
        else if (qno == 1) {
            __napi_schedule(&amp;priv-&gt;low_napi);
        else if (qno == 2) {
            __napi_schedule(&amp;priv-&gt;lro_napi);
...
</code></pre>

<h3 id="path-from-ethernets-poll">Path from ethernet’s poll</h3>
<p>drivers/staging/fsl_ppfe/pfe_eth.c:</p>
<pre><code class="language-cpp line-numbers">static int pfe_eth_lro_poll(struct napi_struct *napi, int budget)
{
	return pfe_eth_poll(priv, napi, 2, budget);
...

static int pfe_eth_low_poll(struct napi_struct *napi, int budget)
{
	return pfe_eth_poll(priv, napi, 1, budget);
...

static int pfe_eth_high_poll(struct napi_struct *napi, int budget )
{
	return pfe_eth_poll(priv, napi, 0, budget);
...

static int pfe_eth_poll(struct pfe_eth_priv_s *priv, struct napi_struct *napi, unsigned int qno, int budget)
{
...
	skb = pfe_eth_rx_skb(dev, priv, qno);
	skb-&gt;protocol = eth_type_trans(skb, dev);
	netif_receive_skb(skb);

</code></pre>

<h3 id="path-from-probe">Path from probe()</h3>
<p>drivers/staging/fsl_ppfe/pfe_ls1012a_platform.c:</p>
<pre><code class="language-cpp line-numbers">static int pfe_platform_probe(struct platform_device *pdev)
	rc = pfe_probe(pfe);
		rc = pfe_hif_init(pfe);
			netif_napi_add(&amp;hif-&gt;dummy_dev, &amp;hif-&gt;napi, pfe_hif_rx_poll, HIF_RX_POLL_WEIGHT);
			err = request_irq(hif-&gt;irq, hif_isr, 0, "pfe_hif", hif);
        rc = pfe_eth_init(pfe);
	    	for (ii = 0; ii &lt; NUM_GEMAC_SUPPORT; ii++)
    	    	err = pfe_eth_init_one(pfe, ii);
					dev = alloc_etherdev_mq(sizeof (*priv), emac_txq_cnt);
					dev-&gt;netdev_ops = &amp;pfe_netdev_ops;
					netif_napi_add(dev, &amp;priv-&gt;low_napi, pfe_eth_low_poll, HIF_RX_POLL_WEIGHT - 16);
					netif_napi_add(dev, &amp;priv-&gt;high_napi, pfe_eth_high_poll, HIF_RX_POLL_WEIGHT - 16);
					netif_napi_add(dev, &amp;priv-&gt;lro_napi, pfe_eth_lro_poll, HIF_RX_POLL_WEIGHT - 16);
					err = register_netdev(dev);
...
static struct of_device_id pfe_match[] = {
    {
        .compatible = "fsl,pfe",
    },
    {},
};

static struct platform_driver pfe_platform_driver = {
    .probe = pfe_platform_probe,
    .remove = pfe_platform_remove,
    .driver = {
        .name = "pfe",
        .of_match_table = pfe_match,
    },
};

</code></pre>


                    </div>
                </div>
            </div>
        </article>
    </main>
    <div id="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar" style="min-height: 298px;">
    <div id="side">
        <aside>
            <div id="side-fixed">
                <div id="categories-4" class="widget widget_categories">
                    <h3 class="side-title">カテゴリー</h3>

                    
                    <ul>
                        
                        <li>
                            <a href="/category/linux">Linux(19)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/shell">シェル(1)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/network">ネットワーク(1)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/site">Web関連(2)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/subcat1">サブカテゴリ１(3)</a>
                            
                            <ul>
                                
                                <li>
                                    <a href="/category/subcat1/subcat2">subcat2(2)</a>
                                    
                                    <ul>
                                        
                                        <li>
                                            <a href="/category/subcat1/subcat2/subcat3">subcat3(1)</a>
                                            
                                        </li>
                                        
                                    </ul>
                                    
                                </li>
                                
                            </ul>
                            
                        </li>
                        
                    </ul>
                </div>
                <div id="search-4" class="widget widget_search">
                    <h3 class="side-title">検索</h3>
                    <div id="search" itemscope="" itemtype="https://schema.org/WebSite">
                        <meta itemprop="url" content="https://linuxref.net/">
                        <form itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction" method="get" class="search-form" action="https://linuxref.net/">
                            <meta itemprop="target" content="https://linuxref.net/?s={s}">
<label><input itemprop="query-input" type="search" class="search-field" placeholder="  サイト内検索" value="" name="s" title="サイト内検索" required=""></label><input type="submit" class="search-submit" value="検索">
                        </form>
                    </div>
                </div>
                <div id="search-4" class="widget widget_search">
                    <h3 class="side-title">Debug</h3>

                    <div>site.data.a(level):</div>
                    <div>site.data.b(level):</div>
                    <div>site.data.c(level):</div>
                    <div>site.data.d(level):</div>
                    <div>page.data[category]:linux</div>
                    <div>page.data[newdata]:</div>

                </div>
            </div>
        </aside>
    </div>
    <!--/#side-->
</div>
</div>
    </div>
    <div id="footer" itemscope="" itemtype="https://schema.org/WPFooter">
    <footer>
        <div id="copyright">
            <p class="copy">Copyright © <span itemprop="copyrightYear">2021</span> <span itemprop="copyrightHolder name">Jianing Bi</span> All Rights Reserved.</p>
        </div>
    </footer>
</div>
</body>

</html>
