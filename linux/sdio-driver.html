<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sdio Driver - Notes ...</title>

    <link rel="shortcut icon" href="/styles/images/favicon.jpg">
    <link rel="icon" href="/styles/images/favicon.jpg">

    <link rel="stylesheet" href="/assets/css/wordpress.css">
    <link rel="canonical" href="/linux/sdio-driver.html">

    <link rel="stylesheet" href="/assets/prism/prism.css">
    <script src="/assets/prism/prism.js"></script>
    <script src="https://kit.fontawesome.com/45a69050db.js" crossorigin="anonymous"></script>

    <meta name="keywords" content="Sdio Driver, Notes ..., 学而不思则罔;思而不学则殆;生命不止;折腾不休">
    <meta name="description" content="学而不思则罔;思而不学则殆;生命不止;折腾不休">
</head>

<body class="index">
    <header id="header" itemscope="" itemtype="https://schema.org/WPHeader">
    <div id="head-in">
        <div id="head-parallax" style="overflow: hidden; background-position: 0px 0px;">
            <div class="head-cover" style="transform: translate(0px, 0px);">
                <div class="info" itemscope="" itemtype="https://schema.org/Website">
                    <h1 id="sitename">
                        <a href="/" itemprop="url"><img src="/assets/images/logo.svg" alt="" width="150" height="150" class="onepoint" itemprop="image" sizes="(max-width: 150px) 100vw, 150px"><span itemprop="name about">Linux Ref</span></a>
                    </h1>
                    <meta itemprop="alternativeHeadline" content="Linux tutorials, settings etc.">
                </div>
                <!--/.info-->
            </div>
            <!--/.head-cover-->
        </div>
        <!--/#head-parallax-->
    </div>
</header>
    <div class="container">
        

<div itemprop="breadcrumb">
    <ol id="breadcrumb">
        <li>
            <i class="fas fa-home"></i>
            <a href="/">ホーム</a>
            <i class="arrow">&gt;</i>
        </li>
        
        
        
            
            
            





<li>

<i class="fas fa-folder-open"></i>
<a href="/category/linux/">Linux</a>

</li>

    </ol>
</div>
<!-- 
    <div>value of name listsize:1</div>
    <div>value of href listsize:1</div>
    <div>value of count:0</div>
    
    <div>value of i:0</div>
    
     -->
<div id="primary" class="clearfix">
    <main id="main">
        <article>
            <div id="core" class="grid">
                <div itemprop="mainEntityOfPage" id="mainEntity" class="post post-109 type-post status-publish format-standard has-post-thumbnail hentry category-server tag-debian tag-linux tag-omv tag-openmediavault tag-server tag-wordpress ja">
                    <header id="article-header">
                        <h1 class="entry-title" itemprop="headline name">Sdio Driver</h1>
                    </header>
                    <div class="clearfix">
                        <p class="meta">
                            <i class="far fa-clock"></i>
                            <span class="date published">
                                <time class="entry-date updated" datetime="2018-03-05T00:00:00+09:00" itemprop="datePublished">
                                    05 Mar 2018
                                </time>
                            </span>
                            <i class="fas fa-redo-alt"></i>
                            <span class="date">
                                <meta itemprop="dateModified" content="2020-08-23T17:24:54+09:00">
                                DUMMY STRING
                            </span>
                        </p>
                        <div id="toc_container">
<span class="toc_title">Contents</span><input id="toc_toggle" type="checkbox" checked><label class="toc_toggle" for="toc_toggle"></label>
                            <ul id="" class="toc_list">
<li class=" toc-h1"><a href="#initializing">Initializing</a></li>
<li class=" toc-h1">
<a href="#call-tree">Call tree</a>
<ul>
<li class=" toc-h2">
<a href="#driversmmchostsdhci-te4395c">drivers/mmc/host/sdhci-te4395.c</a>
<ul>
<li class=" toc-h3"><a href="#te4395_sdhci_probe">te4395_sdhci_probe()</a></li>
</ul>
</li>
<li class=" toc-h2">
<a href="#driversmmchostsdhci-pltfmc">drivers/mmc/host/sdhci-pltfm.c</a>
<ul>
<li class=" toc-h3"><a href="#sdhci_pltfm_init">sdhci_pltfm_init()</a></li>
</ul>
</li>
<li class=" toc-h2">
<a href="#driversmmccorehostc">drivers/mmc/core/host.c</a>
<ul>
<li class=" toc-h3"><a href="#mmc_alloc_host">mmc_alloc_host()</a></li>
</ul>
</li>
<li class=" toc-h2">
<a href="#driversmmccorecorec">drivers/mmc/core/core.c</a>
<ul>
<li class=" toc-h3"><a href="#mmc_rescan">mmc_rescan()</a></li>
<li class=" toc-h3"><a href="#mmc_rescan_try_freq">mmc_rescan_try_freq()</a></li>
<li class=" toc-h3"><a href="#mmc_detect_change">mmc_detect_change()</a></li>
</ul>
</li>
<li class=" toc-h2">
<a href="#driversmmccoresdioc">drivers/mmc/core/sdio.c</a>
<ul>
<li class=" toc-h3"><a href="#mmc_attach_sdio">mmc_attach_sdio()</a></li>
</ul>
</li>
<li class=" toc-h2">
<a href="#driversmmchostsdhcic">drivers/mmc/host/sdhci.c</a>
<ul>
<li class=" toc-h3"><a href="#sdhci_irq">sdhci_irq()</a></li>
<li class=" toc-h3"><a href="#sdhci_thread_irq">sdhci_thread_irq()</a></li>
<li class=" toc-h3"><a href="#sdhci_alloc_host">sdhci_alloc_host()</a></li>
<li class=" toc-h3"><a href="#sdhci_add_host">sdhci_add_host()</a></li>
<li class=" toc-h3"><a href="#__sdhci_add_host">__sdhci_add_host()</a></li>
</ul>
</li>
</ul>
</li>
</ul>
                        </div>
                        <ul id="markdown-toc">
  <li><a href="#initializing" id="markdown-toc-initializing">Initializing</a></li>
  <li>
<a href="#call-tree" id="markdown-toc-call-tree">Call tree</a>    <ul>
      <li>
<a href="#driversmmchostsdhci-te4395c" id="markdown-toc-driversmmchostsdhci-te4395c">drivers/mmc/host/sdhci-te4395.c</a>        <ul>
          <li><a href="#te4395_sdhci_probe" id="markdown-toc-te4395_sdhci_probe">te4395_sdhci_probe()</a></li>
        </ul>
      </li>
      <li>
<a href="#driversmmchostsdhci-pltfmc" id="markdown-toc-driversmmchostsdhci-pltfmc">drivers/mmc/host/sdhci-pltfm.c</a>        <ul>
          <li><a href="#sdhci_pltfm_init" id="markdown-toc-sdhci_pltfm_init">sdhci_pltfm_init()</a></li>
        </ul>
      </li>
      <li>
<a href="#driversmmccorehostc" id="markdown-toc-driversmmccorehostc">drivers/mmc/core/host.c</a>        <ul>
          <li><a href="#mmc_alloc_host" id="markdown-toc-mmc_alloc_host">mmc_alloc_host()</a></li>
        </ul>
      </li>
      <li>
<a href="#driversmmccorecorec" id="markdown-toc-driversmmccorecorec">drivers/mmc/core/core.c</a>        <ul>
          <li><a href="#mmc_rescan" id="markdown-toc-mmc_rescan">mmc_rescan()</a></li>
          <li><a href="#mmc_rescan_try_freq" id="markdown-toc-mmc_rescan_try_freq">mmc_rescan_try_freq()</a></li>
          <li><a href="#mmc_detect_change" id="markdown-toc-mmc_detect_change">mmc_detect_change()</a></li>
        </ul>
      </li>
      <li>
<a href="#driversmmccoresdioc" id="markdown-toc-driversmmccoresdioc">drivers/mmc/core/sdio.c</a>        <ul>
          <li><a href="#mmc_attach_sdio" id="markdown-toc-mmc_attach_sdio">mmc_attach_sdio()</a></li>
        </ul>
      </li>
      <li>
<a href="#driversmmchostsdhcic" id="markdown-toc-driversmmchostsdhcic">drivers/mmc/host/sdhci.c</a>        <ul>
          <li><a href="#sdhci_irq" id="markdown-toc-sdhci_irq">sdhci_irq()</a></li>
          <li><a href="#sdhci_thread_irq" id="markdown-toc-sdhci_thread_irq">sdhci_thread_irq()</a></li>
          <li><a href="#sdhci_alloc_host" id="markdown-toc-sdhci_alloc_host">sdhci_alloc_host()</a></li>
          <li><a href="#sdhci_add_host" id="markdown-toc-sdhci_add_host">sdhci_add_host()</a></li>
          <li><a href="#__sdhci_add_host" id="markdown-toc-__sdhci_add_host">__sdhci_add_host()</a></li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="initializing">Initializing</h1>
<ul>
  <li>SD Host’s initializing starts from <a href="#te4395_sdhci_probe">te4395_sdhci_probe()</a>.</li>
  <li>SDIO card’s initializing starts from <a href="#sdhci_irq">sdhci_irq()</a>.</li>
</ul>

<h1 id="call-tree">Call tree</h1>

<h2 id="driversmmchostsdhci-te4395c">drivers/mmc/host/sdhci-te4395.c</h2>

<h3 id="te4395_sdhci_probe">te4395_sdhci_probe()</h3>

<pre><code class="language-cpp line-numbers">static int te4395_sdhci_probe(struct platform_device *pdev)
{
...
	host = sdhci_pltfm_init(pdev, &amp;te4395_sdhci_pdata, sizeof(*te4395_host));
...
	if ((ret = sdhci_add_host(host)) &lt; 0)
		goto err
...
</code></pre>

<h2 id="driversmmchostsdhci-pltfmc">drivers/mmc/host/sdhci-pltfm.c</h2>

<h3 id="sdhci_pltfm_init">sdhci_pltfm_init()</h3>

<pre><code class="language-cpp line-numbers">struct sdhci_host *sdhci_pltfm_init(struct platform_device *pdev,
			const struct sdhci_pltfm_data *pdata,
			size_t priv_size)
{
...
	host = sdhci_alloc_host(&amp;pdev-&gt;dev,
			sizeof(struct sdhci_pltfm_host) + priv_size);
</code></pre>

<h2 id="driversmmccorehostc">drivers/mmc/core/host.c</h2>
<h3 id="mmc_alloc_host">mmc_alloc_host()</h3>
<pre><code class="language-cpp line-numbers">struct mmc_host *mmc_alloc_host(int extra, struct device *dev)
{
...
	INIT_DELAYED_WORK(&amp;host-&gt;detect, mmc_rescan);
	INIT_DELAYED_WORK(&amp;host-&gt;sdio_irq_work, sdio_irq_work);
...
</code></pre>

<h2 id="driversmmccorecorec">drivers/mmc/core/core.c</h2>
<h3 id="mmc_rescan">mmc_rescan()</h3>
<pre><code class="language-cpp line-numbers">static const unsigned freqs[] = { 400000, 300000, 200000, 100000 };
...
void mmc_rescan(struct work_struct *work)
{
...
	for (i = 0; i &lt; ARRAY_SIZE(freqs); i++) {
		if (!mmc_rescan_try_freq(host, max(freqs[i], host-&gt;f_min)))
...
</code></pre>
<p>then <a href="#mmc_rescan_try_freq">mmc_rescan_try_freq()</a></p>

<h3 id="mmc_rescan_try_freq">mmc_rescan_try_freq()</h3>
<pre><code class="language-cpp line-numbers">static int mmc_rescan_try_freq(struct mmc_host *host, unsigned freq)
{
...
	mmc_power_up(host, host-&gt;ocr_avail);

	mmc_go_idle(host);

	mmc_send_if_cond(host, host-&gt;ocr_avail);

	if (!mmc_attach_sdio(host))
		return 0;

	if (!mmc_attach_sd(host))
		return 0;

	if (!mmc_attach_mmc(host))
		return 0;

	mmc_power_off(host);
	return -EIO;
}
</code></pre>

<h3 id="mmc_detect_change">mmc_detect_change()</h3>
<pre><code class="language-cpp line-numbers">void mmc_detect_change(struct mmc_host *host, unsigned long delay)
{
    _mmc_detect_change(host, delay, true);
}
...
static void _mmc_detect_change(struct mmc_host *host, unsigned long delay,
                bool cd_irq)
{
...
	mmc_schedule_delayed_work(&amp;host-&gt;detect, delay);
}
</code></pre>
<p>goto delayed work <a href="#mmc_rescan">mmc_rescan()</a> accroding to <a href="#mmc_alloc_host">mmc_alloc_host()</a></p>

<h2 id="driversmmccoresdioc">drivers/mmc/core/sdio.c</h2>

<h3 id="mmc_attach_sdio">mmc_attach_sdio()</h3>
<pre><code class="language-cpp line-numbers">int mmc_attach_sdio(struct mmc_host *host)
{
...
	err = mmc_send_io_op_cond(host, 0, &amp;ocr);
	rocr = mmc_select_voltage(host, ocr);
	err = mmc_sdio_init_card(host, rocr, NULL, 0);
...
}

</code></pre>

<h2 id="driversmmchostsdhcic">drivers/mmc/host/sdhci.c</h2>

<h3 id="sdhci_irq">sdhci_irq()</h3>
<pre><code class="language-cpp line-numbers">static irqreturn_t sdhci_irq(int irq, void *dev_id)
{
...
	if (intmask &amp; (SDHCI_INT_CARD_INSERT | SDHCI_INT_CARD_REMOVE)) {
		...
		host-&gt;thread_isr |= intmask &amp; (SDHCI_INT_CARD_INSERT |
			SDHCI_INT_CARD_REMOVE);
		result = IRQ_WAKE_THREAD;
	}
...
}
</code></pre>
<p>return IRQ_WAKE_THREAD, so <a href="#sdhci_thread_irq">sdhci_thread_irq()</a> is executed.</p>

<h3 id="sdhci_thread_irq">sdhci_thread_irq()</h3>
<pre><code class="language-cpp line-numbers">static irqreturn_t sdhci_thread_irq(int irq, void *dev_id)
{
...
	if (isr &amp; (SDHCI_INT_CARD_INSERT | SDHCI_INT_CARD_REMOVE)) {
		struct mmc_host *mmc = host-&gt;mmc;
		mmc_detect_change(mmc, msecs_to_jiffies(200));
	}

</code></pre>
<p>when card’s insert and remove interrupt occurs, call <a href="#mmc_detect_change">mmc_detect_change()</a></p>

<h3 id="sdhci_alloc_host">sdhci_alloc_host()</h3>

<pre><code class="language-cpp line-numbers">struct sdhci_host *sdhci_alloc_host(struct device *dev,
	size_t priv_size)
{
...
	mmc = mmc_alloc_host(sizeof(struct sdhci_host) + priv_size, dev);
...
}
</code></pre>

<h3 id="sdhci_add_host">sdhci_add_host()</h3>

<pre><code class="language-cpp line-numbers">int sdhci_add_host(struct sdhci_host *host)
{
...
	ret = sdhci_setup_host(host);

	ret = __sdhci_add_host(host);
</code></pre>
<p>in sdhci_setup_host(), setting clk, power, etc. accroding caps…</p>

<h3 id="__sdhci_add_host">__sdhci_add_host()</h3>

<pre><code class="language-cpp line-numbers">int __sdhci_add_host(struct sdhci_host *host)
{
...
	tasklet_init(&amp;host-&gt;finish_tasklet,
        sdhci_tasklet_finish, (unsigned long)host);
	
	timer_setup(&amp;host-&gt;timer, sdhci_timeout_timer, 0);
	timer_setup(&amp;host-&gt;data_timer, sdhci_timeout_data_timer, 0);

	init_waitqueue_head(&amp;host-&gt;buf_ready_int);
	
	ret = request_threaded_irq(host-&gt;irq, sdhci_irq, sdhci_thread_irq,
	                   IRQF_SHARED, mmc_hostname(mmc), host);
...
}
</code></pre>

                    </div>
                </div>
            </div>
        </article>
    </main>
    <div id="sidebar" itemscope="itemscope" itemtype="http://schema.org/WPSideBar" style="min-height: 298px;">
    <div id="side">
        <aside>
            <div id="side-fixed">
                <div id="categories-4" class="widget widget_categories">
                    <h3 class="side-title">カテゴリー</h3>

                    
                    <ul>
                        
                        <li>
                            <a href="/category/linux">Linux(19)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/shell">シェル(1)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/network">ネットワーク(1)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/site">Web関連(2)</a>
                            
                        </li>
                        
                        <li>
                            <a href="/category/subcat1">サブカテゴリ１(3)</a>
                            
                            <ul>
                                
                                <li>
                                    <a href="/category/subcat1/subcat2">subcat2(2)</a>
                                    
                                    <ul>
                                        
                                        <li>
                                            <a href="/category/subcat1/subcat2/subcat3">subcat3(1)</a>
                                            
                                        </li>
                                        
                                    </ul>
                                    
                                </li>
                                
                            </ul>
                            
                        </li>
                        
                    </ul>
                </div>
                <div id="search-4" class="widget widget_search">
                    <h3 class="side-title">検索</h3>
                    <div id="search" itemscope="" itemtype="https://schema.org/WebSite">
                        <meta itemprop="url" content="https://linuxref.net/">
                        <form itemprop="potentialAction" itemscope="" itemtype="https://schema.org/SearchAction" method="get" class="search-form" action="https://linuxref.net/">
                            <meta itemprop="target" content="https://linuxref.net/?s={s}">
<label><input itemprop="query-input" type="search" class="search-field" placeholder="  サイト内検索" value="" name="s" title="サイト内検索" required=""></label><input type="submit" class="search-submit" value="検索">
                        </form>
                    </div>
                </div>
                <div id="search-4" class="widget widget_search">
                    <h3 class="side-title">Debug</h3>

                    <div>site.data.a(level):</div>
                    <div>site.data.b(level):</div>
                    <div>site.data.c(level):</div>
                    <div>site.data.d(level):</div>
                    <div>page.data[category]:linux</div>
                    <div>page.data[newdata]:</div>

                </div>
            </div>
        </aside>
    </div>
    <!--/#side-->
</div>
</div>
    </div>
    <div id="footer" itemscope="" itemtype="https://schema.org/WPFooter">
    <footer>
        <div id="copyright">
            <p class="copy">Copyright © <span itemprop="copyrightYear">2021</span> <span itemprop="copyrightHolder name">Jianing Bi</span> All Rights Reserved.</p>
        </div>
    </footer>
</div>
</body>

</html>
